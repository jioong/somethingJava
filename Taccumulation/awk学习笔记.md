# AWK #
  
*AWK* 程序语言的设计是为了简化一般文本处理的工作。  
  
## AWK 命令行 ##
  
*awk* 的调用可以定义变量、提供程序并且指定输入文件：  
```awk
	awk [ -F fs ] [ -v var=value ... ] 'program' [ --] \
		[ var=value ... ] [ file[s] ]  
  
	awk [ -F fs ] [ -v var=value ... ] -f programfile [ --] \
		[ var=value ... ] [ file[s] ]
```  
  
短程序通常是直接在命令行上提供，而较长的程序，则通过 `-f` 选项指定。遇到需连接被指名的程序文件以得到完整的程序时，则可重复使用此选项。  
如果命令行没有指定文件名，则 `awk` 读取标注输入。  
`--` 是特殊选项：指出 `awk` 本身已没有更进一步的命令行选项。任何接下来的选项都可以被该程序使用。  
`-F` 选项是用来重新定义默认字段分隔符，一般惯例将其作为第一个命令行选项。紧接在 `-F` 选项后的 `fs` 参数是一个正则表达式，或是被提供作为下一个参数。字段分隔符也可是指使用 **内建变量 FS** 所指定的。  
  
## AWK 程序模型 ##
  
> *awk* 把输入流看做一连串记录的集合，每条记录都可进一步细分为字段。通常，一行一条记录，而字段则由一个或多个非空白字符的单词组成。  

注意：是什么构成一条记录和一个字段，完全是由程序员控制的，其 **它们的定义，甚至可以在处理期间更改。**  
  
一个 `awk` 程序是一对以 **模式** 与大括号框起来的 **操作** 组合而成的。还可以加上实现操作细节的 **函数** 。针对每个匹配与输入数据的模式，操作会被执行，且所有模式都会 **针对每条输入记录** 而检查。  
模式和操作可以省略其中一个。如果模式省略，则操作将会被应用到每条输入记录；如果操作被省略，则默认操作为将匹配的记录打印到标准输出。如下：  
```awk
	pattern { action }				// 如果模式匹配，则执行操作
	pattern							// 如果模式匹配，则打印记录
			{ action } 				// 针对每条记录，执行操作  
```  
输入会自动地由一个输入文件切换到下一个输入文件，且 `awk` 本身通常会处理每个输入文件的打开、读取和关闭，以允许用户程序专心致力于 **记录的处理。**  
模式多半是数字或字符串表达式，但是 `awk` 通过保留字 `BEGIN` 和 `END` 提供两种特殊的模式。  
* 与 `BEGIN` 关联的操作只会执行一次，在任何命令行文件或一般命令行赋值被处理之前，但是在任何开头的 `-v` 选项指定已经完成之后。它大多用于处理程序所需要的任何特殊初始化工作。  
* `END` 操作也是只执行一次，用于所有输入数据已被处理完之后。它多半用于产生摘要报告，或是执行清除操作。  
* `BEGIN, END` 模式可以是任意顺序的，可以存在于 `awk` 程序内的任何位置。为了方便，通常将 `BEGIN` 模式放在程序的第一个位置，而将 `END` 模式放在最后。  
* 当指定多个 `BEGIN, END` 模式时，将被按照在 `awk` 程序里的顺序，一次执行。  

## 程序元素 ##
  
`awk` 提供标量和数组两种变量来保存数据、数字和字符串，还提供一些语句类型用于处理数据：赋值、注释、条件、函数、输入、循环和输出。  
  
### 注释与空白 ###
  
`awk` 的注释从 `#` 开始到该行结束。  
语言里的任何地方都能有空白，也允许使用任何长度的空白字符。通过适当的使用空行与缩进，可以增进程序的可读性。  
单条语句通常不能被分割跨越多行，除非在行切割的地方立即前置一个反斜杠。   
  
### 字符串与字符串表达式 ###
  
`awk` 里的字符串常数以引号定界。字符串可以包含任何 *8-bit* 的字符，除了控制字符 *NUL* 以外。`awk` 字符串包含零至多个字符，且在字符串的长度上没有限制，视可用内存而定。字符串表达式赋值给变量后，会自动建立一个字符串，且变量的前一个字符串值所占用的内存也会被自动回收。  
反斜杠转义序列允许非打印字符的表示。  
`awk` 提供了许多方便好用的 **内建函数**，可在字符串上执行。  
字符串的比较，用得上传统的关系运算符: `==, !=, <, <=, >, >=` 。比较后返回 1 为真， 0 为假。比较不同长度的字符串，且其中一个字符串为另一个的初始子字符串时，较短的会定义为小于较长的那个。  
不同于大多数程序语言用于字符串数据类型：`awk` 并无特殊的字符串接续运算符。也就是说，两个连续字符串，会自动连接在一起。  
将数字转换为字符串，通过数字连接空字符串即可: `n = 123; s = "" n`, 把 123“ 赋给 `s`。当数字无法确切地表示时，会出现一些警告。  
`awk` 功能强大的地方大多来自于它对正则表达式的支持。有两个运算符 `~（匹配）` 与 `!~（不匹配）` 。  
  
### 数字与数值表达式 ###
  
所有 `awk` 里的数字，都以双精度的浮点值表示。浮点数可以包含一个末端以字母 *e,E* 所表示的 10 次方指数以及可选地带正负号的一个整数。`awk` 将字符串转换为数字：只要加个零到字符串里。例如：`s = "1234"` ,接着是 `n = 0 + s`，便将数字 1234 赋给 `n` 了。  
浮点数有精度限制，有些值无法准确表示：计算的次序很重要，且计算的结果通常只是尽可能地表示为最接近的数字。  
  
**awk 的数值运算符(优先级由大到小)**  
![数值运算符](./images/awk_operator.png "数值运算符")  
  
### 标量变量 ###
  
保存单一值的变量叫做标量。 **变量无须先进行声明。** 相反的，它会在程序里第一次使用它的时候自动被建立。通常是通过指定其值达成，该值可能是数字或是字符串。所有的 `awk` 变量在建立时其初始值为一个空字符创，但是当需要数值时，它会被视为零。变量名称在实际上没有长度限制。另外， `awk` 的变量名称是大小写敏感的。一般，将局部变量全设为小写、全局变量第一个字母大写，而内建变量则全是大写。  
  
**awk 内建变量：**  
* `FILENAME` --- 当前输入文件的名称。  
* `FNR` --- 当前输入文件的记录数。  
* `FS` --- 字段分隔符，默认为空格。  
* `NF` --- 当前记录的字段数。  
* `NR` --- 在工作 *job* 中的记录数。  
* `OFS` --- 输出字段分隔符，默认为空格。  
* `ORS` --- 输出记录分隔符，默认为换行 `"\n"` 。  
* `RS` --- 输入记录分隔符，默认为换行父。  

### 数组变量 ###
  
`awk` 里的数组变量遵循与标量变量相同的命名规则，只不过它包含零到多个数据项，通过紧接着名称的数组索引进行选定。`awk` 允许在数组名称之后，以方括号将任意数字或字符串表达式括起来作为索引。  
以任意值为索引的数组称为 **关联数组** ，因为它们的名称与值是相关联的。重要的是，`awk` 将其应用于数组中，允许查找、插入以及删除等操作，在一定时间内完成，与存储多少项目无关。  
`awk` 里的数组无须声明也无须配置：数组的存储空间在引用新元素时会自动增长。数组存储空间是 **稀疏的：只有那些确实被引用到的元素才会被配置。** 同时，`awk` 不要求所有的元素是相同类型的。  
当元素不在需要时，其存储空间可被回收利用。 `delete array[index]` 会从数组中删除元素，也可通过 `delete array` 删除所有的元素。  
一个变量不能同时用作标量变量和数组变量，当使用 `delete` 语句删除数组的元素时，不会删除它的名称。  
  
`awk` 通过将“以逗号分割的索引列表”看做一个字符串，而使用多个索引模拟数组。  
  
### 命令行参数 ###
  
`awk` 对于命令行的自动化处理，意味着 `awk` 程序几乎不需要关心它们自己。`awk` 通过内建变量 `ARGC(参数计数)` 与 `ARGV(参数值)` 让命令行参数可用。其中第 0 个项目是 `awk` 程序本身的名称。  
`awk` 一见到参数含有程序内容或是 特殊 `--` 选项时，它会立即停止将参数解释为选项。任何接下来看起来像是选项的参数，都必须有程序处理，并接着从 `AEGV` 中被删除，或设置为空字符串。  
  
### 环境变量 ###
  
`awk` 提供访问内建数组 `ENVIRON` 中所有的环境变量。`ENVIRON` 数组并无特别支出，可以依需要来加入、删除及修改项目。*POSIX* 要求子进程继承 `awk` 启动时生效的环境，无法将对于 `ENVIRON` 数组的变更传递给子进程，或是给内建函数。应该将其看成一个只读数组。
  
## 记录与字段 ##
  
在 `awk` 程序化模式中，通过输入文件隐含循环的每一次迭代，会处理单一记录 *record*，通常是一行文本。记录可进一步分割为更小的字符串，叫做字段  *field* 。  
  
### 记录分隔符 ###
  
默认情况下，记录是被换行分割的数行文本，但 `awk` 允许通过内建变量 `RS` 改变记录分隔符。*gawk, mawk* 提供的一个扩展功能： `RS` 可以是正则表达式。  
使用正则表达式记录分割字符时，匹配分割字符的文本不再是由 `RS` 值决定  
  
### 字段分割字符 ###
  
字段彼此是被匹配字段分割字符 `FS` 的当前字符串值分割。`FS` 默认为单一空格，它接受特殊的解释方式：一个或多个空白字符（空格与制表符）以及行的开头与结尾的空白，都将被忽略。  
`FS` 只有在超过一个字符时，才会被认为是正则表达式。例如，`FS="."` 指的是以 `.` 作为字段分隔符，而不是正则表达式所指的任何单一字符 。  
  
### 字段 ###
  
字段可以用特殊名称 `$1, $2, $3, ... $NF` 供 `awk` 程序使用。字段引用无需是固定的，有必要的话，可以转换为整数值。  
特殊字段名称 `$0` 引用到当前记录，初始值是从输入流中读取的，且记录分割字符不是记录的一部分。引用到 0 到 `NF` 范围以上的字段编号是不会有错：它们会返回空字符串，且不会建立新字段，除非指定值给它们。引用负值字段编号会发生严重的错误。引用分数或非数字，则字段编号是在实现期定义的。  
字段如同一般变量，也可以赋值。  
  
## 模式与操作 ##
  
模式与操作是构成 `awk` 程序的核心。`awk` 的非传统数据驱动程序模式，使得它更吸引用户使用，也成就了许多 `awk` 程序的简洁形式。  
   
### 模式 ###
  
模式由字符串与/或数字表达式构建而成：一旦它们计算出当前输入记录的值为非零，则实行结合性的操作。如果模式是正则表达式，则意志次表达式会被拿来与整个输入记录进行匹配。  
  
`awk` 在匹配功能上还可以使用 **范围表达式 range expression 。** 以逗号隔开的两个表达式，会从匹配与左边表达式出开始取样，直到匹配右边的表达式。如果两个范围表达式匹配后匹配于一条记录，则选定该单一记录。  
  
在 `BEGIN` 操作里， `FILENAME, FNR, NF, NR` 初始都没有定义，引用它们时，会返回 *null* 字符串或零。  
如果程序里仅包括 `BEGIN` 模式的操作，则 `awk` 会在完成最后一个操作之后退出，而 **不需要读取任何文件。**  
进入第一个 `END` 操作时， `FILENAME` 是最后一个要处理的输入文件，而 `FNR, NF, NR` 则会保留它们从最后一条输入记录而来的值。在 `END` 操作里的 `$0` 是不可靠的。  
  
### 操作 ###
  
操作段落可选地接在一个模式之后，也就是操作所在之处：标明了它如何处理该记录。  
`awk` 提供了许多语句类型，可允许使用任意程序的构建。